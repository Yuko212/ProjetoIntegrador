<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CiberTech</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/logout.css">
    <link rel="stylesheet" href="../css/index.css">
</head>
<body>
    <script src="../js/auth.js"></script>
    <header id="main-header">
        <div class="cabeçalho">
            <a href="index.html" class="logo">
                <span class="logo-text">CiberTech</span>                
            </a>

            <nav class="main-nav">
                <a href="dashboard.html" class="nav-link">Home</a>
                <a href="peca.html" class="nav-link">Design</a>
                <a href="statuspedido.html" class="nav-link">Acompanhamento</a>
                <a href="historico.html" class="nav-link">Histórico</a>
                <a href="meuspedidos.html" class="nav-link">Meus Pedidos</a>
            </nav>

            <button class="botao-logout" onclick="logout()">
                Sair
            </button>
        </div>
    </header>

    <div class="container-principal">
        <aside class="painel-perfil">
            <div class="area-icone">
                <img id="icone-usuario" src="../img/icone.png" alt="Ícone do Usuário" class="icone-perfil">
                <p class="editar-conta">Editar conta</p>
                <input type="file" id="input-arquivo-icone" accept="image/*" style="display: none;">
                <button id="botao-mudar-icone" class="botao-icone">Mudar Ícone</button>
            </div>
        
            <div id="modal-edicao" class="modal-edicao" style="display:none;">
                <div class="modal-conteudo">
                    <h3 id="titulo-edicao">Editar</h3>
                    <input id="input-edicao" type="text" class="input-edicao">
                    <button id="salvar-edicao" class="btn-salvar">Salvar</button>
                    <button id="fechar-edicao" class="btn-fechar">Cancelar</button>
                </div>
            </div>
            
            <div class="modal-selecao-icone" id="modal-selecao">
                <div class="conteudo-modal"> <h3>Selecione um Ícone</h3>
                    <div class="galeria-icones">
                        </div>
                    <button id="fechar-selecao-icone" class="botao-fechar-modal">Fechar</button>
                </div>
            </div>

            <div class="grupo-informacao">
                <label for="nome" class="rotulo-info">Nome</label>
                <div class="campo-info" id="campo-nome">
                    <span class="valor-info">Carregando...</span>
                    <span class="icone-seta">></span>
                </div>
            </div>

            <div class="grupo-informacao">
                <label for="email" class="rotulo-info">E-mail</label>
                <div class="campo-info" id="campo-email">
                    <span class="valor-info">Carregando...</span>
                    <span class="icone-seta">></span>
                </div>
            </div>

            <div class="grupo-informacao">
                <label for="senha" class="rotulo-info">Senha</label>
                <div class="campo-info" id="campo-senha">
                    <span class="valor-info">**********</span>
                    <span class="icone-seta">></span>
                </div>
            </div>
            
            <div class="logotipo">
                <img src="../img/cibertech-logo.png" alt="Logotipo CiberTech" class="icone-robo">
                
            </div>
        </aside>

        <main class="area-pedidos">
            <button class="botao-acao" onclick="window.location.href='peca.html'">
                Criar um novo pedido
            </button>
        
            <button class="botao-acao">
                Meu histórico de pedidos
            </button>
        
            <button class="botao-acao">
                Detalhes do meu pedido
            </button>
        </main>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        verificarLogin();
    
        document.addEventListener('DOMContentLoaded', () => {
    
            const usuarioLocal = getUsuario();
    
            async function carregarDadosUsuario() {
                try {
                    const resposta = await fetch(`http://localhost:1880/usuario?email=${usuarioLocal.email}`);
                    const dados = await resposta.json();

                    if (dados.status !== "ok") {
                        alert("Erro ao carregar dados do usuário.");
                        return;
                    }

                    dadosUsuario = dados;

                    document.querySelector('#campo-nome .valor-info').textContent = dados.nome;
                    document.querySelector('#campo-email .valor-info').textContent = dados.email;

                    const senhaMascarada = "*".repeat(dados.senha.length);
                    document.querySelector('#campo-senha .valor-info').textContent = senhaMascarada;

                } catch (erro) {
                    console.error("Erro ao consultar o servidor:", erro);
                    alert("Não foi possível carregar seus dados.");
                }
            }
            carregarDadosUsuario();

            const iconeUsuario = document.getElementById('icone-usuario');
            const botaoMudarIcone = document.getElementById('botao-mudar-icone');
            const inputArquivo = document.getElementById('input-arquivo-icone');
    
            botaoMudarIcone.addEventListener('click', () => {
                inputArquivo.click();
            });
    
            inputArquivo.addEventListener('change', (evento) => {
                const arquivo = evento.target.files[0];
    
                if (arquivo) {
                    const leitor = new FileReader();
    
                    leitor.onload = (e) => {
                        iconeUsuario.src = e.target.result;
                    };
    
                    leitor.readAsDataURL(arquivo);
                }
            });
    
         
                let campoAtual = null; 
                let dadosUsuario = null; 

                function abrirEdicao(campo, valorInicial) {
                    campoAtual = campo;
                    document.getElementById("input-edicao").value = valorInicial;
                    document.getElementById("modal-edicao").style.display = "flex";
                }

                function fecharModal() {
                    document.getElementById("modal-edicao").style.display = "none";
                }

                document.querySelector('#campo-nome').addEventListener("click", () => {
                    abrirEdicao("nome", dadosUsuario.nome);
                });

                document.querySelector('#campo-email').addEventListener("click", () => {
                    abrirEdicao("email", dadosUsuario.email);
                });

                document.querySelector('#campo-senha').addEventListener("click", () => {
                    abrirEdicao("senha", dadosUsuario.senha);
                });

       
                document.getElementById("fechar-edicao").addEventListener("click", fecharModal);

                document.getElementById("salvar-edicao").addEventListener("click", async () => {
                    const novoValor = document.getElementById("input-edicao").value.trim();

                    if (!novoValor) {
                        alert("Digite um valor válido.");
                        return;
                    }

                    dadosUsuario[campoAtual] = novoValor; 

                    try {
                        const resposta = await fetch("http://localhost:1880/atualizarUsuario", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(dadosUsuario)
                        });

                        const data = await resposta.json();

                        if (data.status === "ok") {
                            alert("Atualizado com sucesso!");

                            document.querySelector('#campo-nome .valor-info').textContent = dadosUsuario.nome;
                            document.querySelector('#campo-email .valor-info').textContent = dadosUsuario.email;
                            document.querySelector('#campo-senha .valor-info').textContent = "*".repeat(dadosUsuario.senha.length);

                            fecharModal();
                        } else {
                            alert("Erro ao atualizar.");
                        }

                    } catch (err) {
                        alert("Erro ao conectar com o servidor.");
                        console.error(err);
                    }
                });
    
        });
    </script>    
</body>
</html>