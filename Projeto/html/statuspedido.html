<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status do Pedido</title>
    <link rel="stylesheet" href="../css/statuspedido.css">
    <link rel="stylesheet" href="../css/footer-header.css">
    <link rel="stylesheet" href="../css/logout.css">
</head>
<body>

  
    <script src="../js/auth.js"></script>
    <header id="main-header">
        <div class="cabeÃ§alho">
            <a href="index.html" class="logo">
                <span class="logo-text">CiberTech</span>                
            </a>

            <nav class="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="peca.html" class="nav-link">Design</a>
                <a href="statuspedido.html" class="nav-link">Acompanhamento</a>
                <a href="#historico" class="nav-link">HistÃ³rico</a>
            </nav>

            <button class="botao-logout" onclick="logout()">
                Sair
            </button>
        </div>
    </header>

    <div class="barra-topo-pedido">
        <button class="botao-branco-arredondado">Minha conta</button>
        <h1 class="titulo-cabecalho">Status do seu pedido</h1>
        <div class="caixa-numero-pedido">NÂº do pedido: 063</div>
    </div>


    <main class="conteiner-principal">
        
        <h2 class="titulo-bloco">Pino Duplo</h2>

        <div class="area-passos">
            <div class="passo-escudo">
                <p>Pedido<br>recebido</p>
            </div>
            <div class="passo-escudo">
                <p>InÃ­cio<br>Esteira em<br>andamento</p>
            </div>
            <div class="passo-escudo">
                <p>Formas<br>posicionadas</p>
            </div>
            <div class="passo-escudo">
                <p>Pedido<br>concluÃ­do</p>
            </div>
        </div>

        <div class="fundo-barra">
            <div class="barra-preenchida" id="minha-barra-progresso"></div>
            <span class="texto-porcentagem" id="texto-porcentagem">0%</span>
        </div>

        <div class="area-botao-central">
            <button class="botao-cinza-central" id="btn-status-pinos">Status dos Pinos</button>

            <a href="detalhe.html" class="botao-cinza-central">
            Detalhes do pedido
        </a>
    
        <a href="peca.html" class="botao-cinza-central">
            Pedir novo produto
        </a>
        </div>

    </main>

    <footer id="main-footer">
        <div class="container footer-container">
            <div class="footer-top">
                <p class="footer-logo">CiberTech</p>
                <nav class="footer-nav">
                    <a href="#funcionalidades" class="footer-link">Funcionalidades</a>
                    <a href="#" class="footer-link">Termos de Uso</a>
                    <a href="#" class="footer-link">Contato</a>
                </nav>
            </div>
            <p class="footer-copy">
                &copy; 2025 CiberTech. Todos os direitos reservados.
            </p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
        
            // --- Constantes ---
            const STATUS_INTERVAL_MS = 2000;
            
            // Elementos do DOM
            const barraProgresso = document.getElementById("minha-barra-progresso");
            const textoPorcentagem = document.getElementById("texto-porcentagem");
            const tituloBloco = document.querySelector(".titulo-bloco");
            const caixaNumeroPedido = document.querySelector(".caixa-numero-pedido");
            const passos = document.querySelectorAll(".passo-escudo");
        
            // BOTÃƒO DE STATUS DOS PINOS (NOVO!)
            const btnPinos = document.getElementById("btn-status-pinos");
        
            // --- Mapeamentos ---
            const MAP_TIPOS = {
                1: "Pino Simples",
                2: "Pino Duplo"
            };
            
            const MAP_PROGRESSO = {
                0: 0,
                1: 25,
                2: 50,
                3: 75,
                4: 100
            };
        
            // --- UtilitÃ¡rio ---
            function getPedidoIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }
        
            // --- AtualizaÃ§Ã£o visual ---
            function atualizarBarraEPassos(estado) {
                const valorProgresso = MAP_PROGRESSO[estado] ?? 0;
                
                setTimeout(() => {
                    barraProgresso.style.width = valorProgresso + "%";
                    textoPorcentagem.textContent = valorProgresso + "%";
                }, 150);
                
                passos.forEach((passo, index) => {
                    let ativo = false;
                    
                    if (index === 0 && estado >= 0) ativo = true;
                    else if (index === 1 && estado >= 1) ativo = true;
                    else if (index === 2 && estado >= 2) ativo = true;
                    else if (index === 3 && estado >= 4) ativo = true;
        
                    passo.classList.toggle('passo-ativo', ativo);
                });
        
                console.log(`Status: ${estado} (${valorProgresso}%)`);
            }
        
            let pollingInterval;
        
            async function buscarStatusEIniciarPolling() {
                const pedidoId = getPedidoIdFromUrl();
                
                if (!pedidoId) {
                    alert("ID do pedido nÃ£o encontrado na URL. Redirecionando.");
                    window.location.href = "dashboard.html";
                    return;
                }
        
                // ðŸ”¥ NOVO: botÃ£o de status dos pinos agora envia o ID corretamente!
                if (btnPinos) {
                    btnPinos.addEventListener("click", () => {
                        window.location.href = `statuspinos.html?id=${pedidoId}`;
                    });
                }
        
                caixaNumeroPedido.textContent = `NÂº do pedido: ${pedidoId}`;
        
                if (!pollingInterval) {
                    pollingInterval = setInterval(buscarStatus, STATUS_INTERVAL_MS);
                    buscarStatus();
                }
            }
        
            async function buscarStatus() {
                const pedidoId = getPedidoIdFromUrl();
                const url = `http://127.0.0.1:1880/status_pedido?id=${pedidoId}`;
                
                try {
                    const resposta = await fetch(url);
                    if (!resposta.ok) throw new Error(`Falha na API: ${resposta.status}`);
                    
                    const dados = await resposta.json();
                    
                    if (dados.estado !== null) {
                        const tipoTexto = MAP_TIPOS[dados.tipo_pedido] || "Pino Desconhecido";
                        tituloBloco.textContent = tipoTexto;
        
                        atualizarBarraEPassos(dados.estado);
        
                        if (dados.estado == 4) {
                            clearInterval(pollingInterval);
                            console.log("Polling finalizado: Pedido concluÃ­do.");
                        }
                    } else {
                        atualizarBarraEPassos(0);
                    }
        
                } catch (erro) {
                    console.error("Erro ao buscar status:", erro);
                }
            }
        
            verificarLogin();
            buscarStatusEIniciarPolling();
        });
        </script>
        

</body>
</html>