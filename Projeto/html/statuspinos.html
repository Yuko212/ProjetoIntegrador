<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status dos Pinos - CiberTech</title>
    <link rel="stylesheet" href="../css/footer-header.css">
    <link rel="stylesheet" href="../css/statuspinos.css">
    <link rel="stylesheet" href="../css/logout.css">
</head>
<body>

    <!-- Cabeﾃｧalho (Header) - Presume-se estilizado por footer-header.css -->
    <script src="../js/auth.js"></script>
    <header id="main-header">
        <div class="cabeﾃｧalho">
            <a href="index.html" class="logo">
                <span class="logo-text">CiberTech</span>
            </a>

            <nav class="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="peca.html" class="nav-link">Design</a>
                <a href="statuspedido.html" class="nav-link">Acompanhamento</a>
                <a href="#historico" class="nav-link">Histﾃｳrico</a>
            </nav>

            <button class="botao-logout" onclick="logout()">
                Sair
            </button>
        </div>
    </header>

    <!-- Barra Topo Pedido -->
    <div class="barra-topo-pedido">
        <button id="btn-minha-conta" class="botao-branco-arredondado">Minha conta</button>
        <h1 class="titulo-cabecalho">Status dos Pinos</h1>
        <div id="numero-pedido-display" class="caixa-numero-pedido">
            Nﾂｺ do pedido: Carregando
        </div>
    </div>

    <!-- Conteﾃｺdo Principal -->
    <main class="conteiner-principal">
        <h2 id="titulo-bloco" class="titulo-bloco">
            Status do Pedido: <span id="pedido-status-titulo"></span>
        </h2>
        
        <!-- Mensagem de Status/Erro/Carregando -->
        <p id="status-message" style="color: red; font-weight: bold; margin-top: 20px;" class="hidden">
            Carregando dados...
        </p>

        <!-- ﾃ〉ea onde os Cartﾃｵes de Pinos serﾃ｣o renderizados -->
        <div id="area-cartoes-pinos" class="area-cartoes-pinos duplo hidden">
            
            <!-- PINO 1 (p1, p2, p3) -->
            <div id="pino-1-container" class="cartao-pino hidden">
                <h2 class="titulo-pino">1ﾂｺ PINO</h2>
                
                <div id="passos-pino-1" class="area-passos-pinos">
                    <!-- Passos do pino 1 serﾃ｣o preenchidos pelo JS -->
                </div>

                <div class="fundo-barra-pino">
                    <div class="barra-preenchida-pino" id="barra-pino-1"></div>
                    <span class="texto-porcentagem-pino" id="texto-pino-1">0%</span>
                </div>
            </div>

            <!-- PINO 2 (p4, p5, p6) -->
            <div id="pino-2-container" class="cartao-pino hidden">
                <h2 class="titulo-pino">2ﾂｺ PINO</h2>
                
                <div id="passos-pino-2" class="area-passos-pinos">
                    <!-- Passos do pino 2 serﾃ｣o preenchidos pelo JS -->
                </div>

                <div class="fundo-barra-pino">
                    <div class="barra-preenchida-pino" id="barra-pino-2"></div>
                    <span class="texto-porcentagem-pino" id="texto-pino-2">0%</span>
                </div>
            </div>
            
        </div>

        <!-- ﾃ〉ea de Botﾃｵes Centrais -->
        <div class="area-botao-central">
            <a href="#" id="link-status-pedido">
                <button class="botao-cinza-central">Status do pedido</button>
            </a>
            <a href="#" id="link-detalhes-pedido" class="botao-cinza-central">
                Detalhes do pedido
            </a>
            <a href="peca.html" class="botao-cinza-central">
                Pedir novo produto
            </a>
        </div>

    </main>

    <!-- Rodapﾃｩ (Footer) - Presume-se estilizado por footer-header.css -->
    <footer id="main-footer">
        <div class="container footer-container">
            <div class="footer-top">
                <p class="footer-logo">CiberTech</p>
                <nav class="footer-nav">
                    <a href="#funcionalidades" class="footer-link">Funcionalidades</a>
                    <a href="#" class="footer-link">Termos de Uso</a>
                    <a href="#" class="footer-link">Contato</a>
                </nav>
            </div>
            <p class="footer-copy">
                &copy; 2025 CiberTech. Todos os direitos reservados.
            </p>
        </div>
    </footer>

    <script>
        // --- Variﾃ｡veis Globais de Controle ---
        const STATUS_INTERVAL_MS = 2000; // 2 segundos para o polling
        let pollingInterval; // Variﾃ｡vel para controlar a repetiﾃｧﾃ｣o
    
        // --- Mapeamentos ---
        const MAP_TIPOS = {
            1: "Pino Simples",
            2: "Pino Duplo"
        };
    
        // ===================================================================
        // FUNﾃﾃ髭S DE UTILIDADE E CONTROLE
        // ===================================================================
    
        function getPedidoIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
    
        function iniciarPolling(id) {
            // 1. Atualiza o nﾃｺmero do pedido no topo
            const caixaNumeroPedido = document.getElementById("numero-pedido-display");
            if (caixaNumeroPedido) {
                caixaNumeroPedido.textContent = `Nﾂｺ do pedido: ${id}`;
            }
            
            // 2. Cria os links dinﾃ｢micos para outras pﾃ｡ginas
            const linkStatus = document.getElementById("link-status-pedido");
            const linkDetalhes = document.getElementById("link-detalhes-pedido");
            if (linkStatus) linkStatus.href = `statuspedido.html?id=${id}`;
            if (linkDetalhes) linkDetalhes.href = `detalhes.html?id=${id}`;
    
            // 3. Inicia o Polling
            if (!pollingInterval) {
                carregarStatusPinos(id); // Executa a primeira busca imediatamente
                pollingInterval = setInterval(() => carregarStatusPinos(id), STATUS_INTERVAL_MS);
            }
        }
    
    
        // ===================================================================
        // BUSCA O STATUS DOS PINOS (Polling Function)
        // ===================================================================
        async function carregarStatusPinos(id) {
            try {
                const url = `http://127.0.0.1:1880/status_pinos?id=${id}`; 
                const resposta = await fetch(url);
    
                if (!resposta.ok) throw new Error(`Erro ${resposta.status} ao consultar pinos na API.`);
    
                const dados = await resposta.json();
                
                // Verifica a validade mﾃｭnima
                if (!dados || dados.tipo_pedido === undefined) {
                    console.error("ERRO: O Node-RED Nﾃグ RETORNOU dados vﾃ｡lidos!");
                    document.getElementById("status-message").textContent = "ERRO: Dados invﾃ｡lidos da API (tipo_pedido ausente).";
                    document.getElementById("status-message").classList.remove('hidden');
                    return;
                }
    
                document.getElementById("status-message").classList.add('hidden');
    
                atualizarInterface(dados);
                verificarConclusao(dados);
                
            } catch (erro) {
                console.error("Falha na comunicaﾃｧﾃ｣o com o backend:", erro);
                document.getElementById("status-message").textContent = "Erro de comunicaﾃｧﾃ｣o com o servidor.";
                document.getElementById("status-message").classList.remove('hidden');
            }
        }
    
    
        // ===================================================================
        // ATUALIZAﾃﾃグ VISUAL DOS PINOS E DA BARRA DE PROGRESSO
        // ===================================================================
        function atualizarInterface(dados) {
            const tipo = Number(dados.tipo_pedido);
    
            // A) Atualiza o tﾃｭtulo e exibe a ﾃ｡rea de cartﾃｵes
            const tituloBloco = document.getElementById("titulo-bloco");
            const areaCartoesPinos = document.getElementById("area-cartoes-pinos");
            const pino1Container = document.getElementById("pino-1-container");
            const pino2Container = document.getElementById("pino-2-container");
    
            if (tituloBloco) tituloBloco.textContent = `Status do Pedido: ${MAP_TIPOS[tipo] || "Desconhecido"}`;
            areaCartoesPinos.classList.remove('hidden');
            
            // B) Exibiﾃｧﾃ｣o dos cartﾃｵes (Simples vs. Duplo)
            pino1Container.classList.remove('hidden');
    
            if (tipo === 1) {
                pino2Container.classList.add('hidden');
                areaCartoesPinos.classList.remove('duplo');
            } 
            else if (tipo === 2) {
                pino2Container.classList.remove('hidden');
                areaCartoesPinos.classList.add('duplo');
            }
    
            // C) Atualiza os passos e barras
            
            // Pino 1 (p1, p2, p3)
            // Usamos (dados.pX || 0) para tratar NULL como 0.
            atualizarCartaoPino(1, dados.p1, dados.p2, dados.p3);
            
            // Pino 2 (p4, p5, p6) - Sﾃｳ para tipo Duplo. Tambﾃｩm trata NULL como 0.
            if (tipo === 2) {
                atualizarCartaoPino(2, dados.p4, dados.p5, dados.p6);
            }
        }
    
        /**
         * Funﾃｧﾃ｣o auxiliar para atualizar um cartﾃ｣o de pino especﾃｭfico (barra + passos).
         * @param {number} pinoNum - 1 ou 2.
         * @param {*} val1, val2, val3 - Valores dos sub-pinos (0, 1, ou null).
         */
        function atualizarCartaoPino(pinoNum, val1, val2, val3) {
            
            const passosContainer = document.getElementById(`passos-pino-${pinoNum}`);
            const barraEl = document.getElementById(`barra-pino-${pinoNum}`);
            const textoEl = document.getElementById(`texto-pino-${pinoNum}`);
            
            if (!passosContainer || !barraEl || !textoEl) return;
            
            // 圷 CORREﾃﾃグ: Usa Number() em combinaﾃｧﾃ｣o com o operador OR (||) para garantir que:
            // Se o valor for NULL (ou undefined, ou 0, ou '0'), ele usa 0.
            // Se for 1, ele usa 1.
            const v1 = Number(val1 || 0);
            const v2 = Number(val2 || 0);
            const v3 = Number(val3 || 0);
    
            // Contador de sub-passos concluﾃｭdos (a soma de 0s e 1s)
            const passosConcluidos = v1 + v2 + v3; 
            
            // Calcula a porcentagem
            const porcentagem = (passosConcluidos / 3) * 100;
    
            // 1. Atualiza a Barra de Progresso
            barraEl.style.width = porcentagem + "%";
            textoEl.textContent = Math.round(porcentagem) + "%";
    
            // 2. Atualiza os Passos
            passosContainer.innerHTML = `
                <p>1ﾂｺ Sub-Passo: ${v1 === 1 ? '笨 Concluﾃｭdo' : '竢ｳ Pendente'}</p>
                <p>2ﾂｺ Sub-Passo: ${v2 === 1 ? '笨 Concluﾃｭdo' : '竢ｳ Pendente'}</p>
                <p>3ﾂｺ Sub-Passo: ${v3 === 1 ? '笨 Concluﾃｭdo' : '竢ｳ Pendente'}</p>
            `;
        }
    
    
        // ===================================================================
        // VERIFICAﾃﾃグ DE CONCLUSﾃグ (SIMPLES OU DUPLO)
        // ===================================================================
        function verificarConclusao(dados) {
            
            const tipo = Number(dados.tipo_pedido); // 1 = simples, 2 = duplo
            let isConcluido = false;
            
            // Prepara os dados, garantindo que tudo ﾃｩ Number e tratando NULL como 0
            const p = {};
            for (let i = 1; i <= 6; i++) {
                // Usa Number(dados['pX'] || 0) para seguranﾃｧa
                p[`p${i}`] = Number(dados[`p${i}`] || 0);
            }
    
            // Condiﾃｧﾃ｣o base para ambos: Pinos 1, 2 e 3 concluﾃｭdos
            const concluidoPino1 = p.p1 === 1 && p.p2 === 1 && p.p3 === 1;
    
            if (tipo === 1) {
                // Lﾃｳgica SIMPLES: Apenas P1, P2 e P3
                isConcluido = concluidoPino1;
            }
            
            if (tipo === 2) {
                // Lﾃｳgica DUPLO: P1-P3 E P4, P5, P6
                const concluidoPino2 = p.p4 === 1 && p.p5 === 1 && p.p6 === 1;
                isConcluido = concluidoPino1 && concluidoPino2;
            }
    
            if (isConcluido) {
                marcarConcluido();
                if (pollingInterval) {
                    clearInterval(pollingInterval); // Para a atualizaﾃｧﾃ｣o automﾃ｡tica
                    pollingInterval = null;
                }
            }
        }
    
    
        // ===================================================================
        // Funﾃｧﾃ｣o FINAL de conclusﾃ｣o dos pinos
        // ===================================================================
        function marcarConcluido() {
            const el = document.getElementById("status-final");
            const titulo = document.getElementById("pedido-status-titulo");
            
            if (el) {
                el.textContent = "笨 Produﾃｧﾃ｣o dos Pinos Concluﾃｭda!";
                el.style.color = "green";
                el.style.fontWeight = "bold";
            }
             if (titulo) {
                titulo.textContent = "CONCLUﾃ好O";
            }
            
            console.log("PINOS CONCLUﾃ好OS! Polling parado.");
        }
    
    
        // ===================================================================
        // CHAMADA DE INICIALIZAﾃﾃグ
        // ===================================================================
        document.addEventListener("DOMContentLoaded", function () {
            const pedidoId = getPedidoIdFromUrl();
            
            if (!pedidoId) {
                alert("ID do pedido nﾃ｣o encontrado na URL. Redirecionando.");
                window.location.href = "dashboard.html";
                return;
            }
            
            console.log("ID do Pedido recebido:", pedidoId);
            
            // Inicia o Polling e atualiza os links
            iniciarPolling(pedidoId);
        });
    </script>
        
</body>
</html>